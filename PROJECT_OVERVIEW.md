# 🥬 Office de Yasai Matcher - プロジェクト概要

## 📖 プロジェクトの目的

「オフィスでやさい」の導入事例マッチングシステムです。企業の課題や要望に基づいて、最適な導入事例を自動的に提案するツールを提供します。

### 解決する課題

- **営業スタッフの負担軽減**: 顧客の要望に合わせた導入事例を素早く見つける
- **マッチング精度の向上**: 業界、従業員数、課題を考慮した精度の高いマッチング
- **導入事例の有効活用**: 蓄積された導入事例データを最大限に活用

---

## 🎯 主な機能

### 1. 導入事例マッチング

**入力項目**:
- 業界（必須）
- 従業員数（任意）
- 課題・要望（必須）

**マッチングアルゴリズム**:
- **業界マッチング**（30点満点）
  - 完全一致: 30点
  - 部分一致: 15点
- **従業員数マッチング**（40点満点）
  - 20%以内の差: 40点
  - 50%以内の差: 27点
  - 100%以内の差: 13点
- **課題マッチング**（30点満点）
  - キーワードベースのマッチング
  - 複数の課題にマッチした場合は加点

**出力**:
- マッチスコア（0-100点）
- マッチした理由の説明
- 導入事例の詳細情報（企業名、業界、従業員数、課題、効果など）

### 2. 複数候補の検索

- 最初のマッチング結果を除外して、次の候補を検索可能
- 複数の導入事例を比較検討できる

### 3. 導入事例データの管理

- CSVファイルからの一括インポート
- PostgreSQL（Supabase）でのデータ管理
- 導入事例の一覧表示

---

## 🏗️ 技術スタック

### フロントエンド
- **React 19** - UIフレームワーク
- **TypeScript** - 型安全性
- **Vite** - ビルドツール
- **Tailwind CSS** - スタイリング
- **Radix UI** - UIコンポーネント
- **TanStack Query** - データフェッチング
- **tRPC** - 型安全なAPI通信

### バックエンド
- **Express** - Webサーバー
- **tRPC** - 型安全なAPI
- **Drizzle ORM** - データベースORM
- **PostgreSQL** - データベース（Supabase）

### インフラ
- **Vercel** - ホスティング・デプロイ
- **Supabase** - データベースホスティング

---

## 📁 プロジェクト構成

```
office-de-yasai-matcher/
├── api/
│   └── server.ts              # Vercel serverless function（メインエントリーポイント）
├── client/
│   ├── src/
│   │   ├── pages/
│   │   │   └── Home.tsx       # メインページ（マッチングUI）
│   │   ├── components/        # UIコンポーネント
│   │   └── lib/
│   │       └── trpc.ts        # tRPCクライアント設定
│   └── public/                # 静的ファイル
├── server/
│   ├── _core/
│   │   ├── context.ts         # tRPCコンテキスト
│   │   ├── oauth.ts           # OAuth認証（現在は無効化）
│   │   └── vite.ts            # 静的ファイル配信
│   ├── routers.ts             # tRPCルーター（マッチングロジック）
│   └── db.ts                  # データベースアクセス
├── drizzle/
│   └── schema.ts              # データベーススキーマ
├── shared/                    # フロントエンド・バックエンド共通コード
├── package.json
├── vercel.json                # Vercel設定
└── tsconfig.json
```

---

## 🔄 データフロー

### マッチング処理の流れ

```
1. ユーザーがフォームに入力
   ↓
2. フロントエンドからtRPC経由でリクエスト
   ↓
3. バックエンドでマッチングアルゴリズム実行
   - 全導入事例を取得
   - 各事例に対してスコア計算
   - スコア順にソート
   ↓
4. 最適な事例を返却
   ↓
5. フロントエンドで結果を表示
```

### データベース構造

#### `cases` テーブル
```sql
- id: 主キー
- companyName: 企業名
- url: 事例URL
- industry: 業界
- employeeCount: 従業員数
- challenges: 課題（JSON配列）
- reasons: 導入理由（JSON配列）
- effects: 効果（JSON配列）
- fullText: 全文
- usageScale: 利用規模
- createdAt: 作成日時
```

---

## 🚀 デプロイ構成

### Vercel構成

- **ビルドコマンド**: `npm run build`
- **出力ディレクトリ**: `dist/public`
- **Serverless Function**: `api/server.ts`
- **ルーティング**: 全てのリクエストを`/api/server`にルーティング

### 環境変数

#### 必須
- `DATABASE_URL`: PostgreSQL接続URL（Supabase）
- `JWT_SECRET`: Cookie署名用シークレット
- `NODE_ENV`: `production`

#### 認証用（必須）
- `VITE_APP_ID`: Google OAuth App ID（Google Cloud Consoleで取得）
- `OAUTH_SERVER_URL`: OAuthサーバーURL（Google Identity Services用）

#### オプション
- `OWNER_OPEN_ID`: 管理者のOpenID（現在は未使用）

---

## 📊 マッチングアルゴリズムの詳細

### スコア計算式

```typescript
総合スコア = 業界スコア + 従業員数スコア + 課題スコア
最大100点
```

### マッチング例

**入力**:
- 業界: "IT"
- 従業員数: 100名
- 課題: "健康経営、従業員の満足度向上"

**計算過程**:
1. 業界が完全一致 → +30点
2. 従業員数が20%以内の差 → +40点
3. 課題が2つマッチ → +20点（最大30点）
4. **合計: 90点**

---

## 🎨 UI/UX

### デザインコンセプト

- **シンプルで使いやすい**: 3つの入力項目のみ
- **視覚的なフィードバック**: マッチスコアと理由を分かりやすく表示
- **レスポンシブデザイン**: モバイル・デスクトップ対応

### 主な画面構成

1. **ヘッダー**: ロゴとプロジェクト名
2. **入力フォーム**: 業界、従業員数、課題
3. **マッチング結果**: 
   - マッチスコア
   - マッチした理由
   - 導入事例の詳細
   - 「次の候補を探す」ボタン

---

## 🔐 セキュリティ

### 認証要件

**`@officedeyasai.jp`のメールアドレスでのみアクセス可能**

- **認証方式**: Google OAuth（シンプルなワンクリック認証）
- **要件**: ブラウザにログインしているGoogleアカウントのメールアドレスが`@officedeyasai.jp`であること
- **実装方法**: 
  - Google Identity Services（One Tap）を使用
  - ブラウザに既にログインしているGoogleアカウントを自動検出
  - メールアドレスのドメインをチェック（`@officedeyasai.jp`のみ許可）
  - 認証済みセッションはCookieで管理（1年間有効）

### 認証フロー

```
1. ユーザーがページにアクセス
   ↓
2. Google Identity Servicesが自動的にブラウザのログイン状態を検出
   ↓
3. ワンクリックで認証（既にログイン済みの場合は自動）
   ↓
4. メールアドレスのドメインをチェック
   - `@officedeyasai.jp` → アクセス許可 ✅
   - その他 → アクセス拒否 ❌
   ↓
5. セッションCookieを発行（1年間有効）
   ↓
6. 認証済みユーザーとしてページにアクセス可能
```

### 実装の特徴

- **シンプル**: 複雑なログインフォーム不要
- **スムーズ**: ブラウザに既にログインしている場合は自動認証
- **セキュア**: Googleの認証システムを利用
- **使いやすい**: 認証後は1年間ログイン状態を維持

### データ保護

- 環境変数による機密情報の管理
- HTTPS通信（Vercelが自動提供）
- SQLインジェクション対策（Drizzle ORM）
- セッションCookieの署名と暗号化

---

## 📈 今後の拡張予定

### 機能追加

- [x] 認証機能の実装（`@officedeyasai.jp`ドメイン） - **実装予定**
- [ ] マッチング履歴の保存
- [ ] お気に入り機能
- [ ] エクスポート機能（PDF、CSV）
- [ ] 詳細検索機能

### 改善

- [ ] マッチングアルゴリズムの精度向上
- [ ] パフォーマンス最適化
- [ ] エラーハンドリングの強化
- [ ] ログ機能の追加

---

## 📝 開発メモ

### データインポート

導入事例データはCSVファイルから一括インポート可能：
```bash
npm run import:csv
```

### ローカル開発

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# 型チェック
npm run check
```

---

## 📞 サポート・問い合わせ

問題が発生した場合は、以下を確認してください：

1. Vercelのデプロイログ
2. Runtime Logs
3. データベース接続状態
4. 環境変数の設定

---

**最終更新**: 2025-10-31

